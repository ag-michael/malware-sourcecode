// Decompiled with JetBrains decompiler
// Type: UpdaterService.CmdService
// Assembly: UpdaterService, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
// MVID: 1FB66A7F-8AE7-472D-85E4-A0D54D3018CC
// Assembly location: C:\Users\flareadmin\Downloads\0f6572e1184084cd1257731eaa6e44af30a46a69679630a87065da9dccd0c32b.exe

using System;
using System.Diagnostics;
using System.IO;
using System.Threading;

namespace UpdaterService
{
  public class CmdService : IDisposable
  {
    private Process _cmdProcess;
    private StreamWriter _streamWriter;
    private AutoResetEvent _outputWaitHandle;
    private string _cmdOutput;

    public CmdService(string cmdPath)
    {
      this._cmdProcess = new Process();
      this._outputWaitHandle = new AutoResetEvent(false);
      this._cmdOutput = string.Empty;
      ProcessStartInfo processStartInfo = new ProcessStartInfo();
      processStartInfo.FileName = cmdPath;
      processStartInfo.UseShellExecute = false;
      processStartInfo.RedirectStandardOutput = true;
      processStartInfo.RedirectStandardInput = true;
      processStartInfo.CreateNoWindow = true;
      this._cmdProcess.OutputDataReceived += new DataReceivedEventHandler(this._cmdProcess_OutputDataReceived);
      this._cmdProcess.StartInfo = processStartInfo;
      this._cmdProcess.Start();
      this._streamWriter = this._cmdProcess.StandardInput;
      this._cmdProcess.BeginOutputReadLine();
    }

    public string ExecuteCommand(string command)
    {
      this._cmdOutput = string.Empty;
      this._streamWriter.WriteLine(command);
      this._streamWriter.WriteLine("echo end");
      this._outputWaitHandle.WaitOne();
      return this._cmdOutput;
    }

    private void _cmdProcess_OutputDataReceived(object sender, DataReceivedEventArgs e)
    {
      if (e.Data == null || e.Data == "end")
        this._outputWaitHandle.Set();
      else
        this._cmdOutput = this._cmdOutput + e.Data + Environment.NewLine;
    }

    public void Dispose()
    {
      this._cmdProcess.Close();
      this._cmdProcess.Dispose();
      this._streamWriter.Close();
      this._streamWriter.Dispose();
    }
  }
}
